<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Broadcast</title>
    <link rel="stylesheet" href="milligram.css">
    <style media="screen">
      #log {
        max-height: 8em;
        overflow: scroll;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Broadcast</h1>
      <button id="connect">Connect Controllers</button>

      <pre><code id="log"></code></pre>

      <div class="row" id="controllers">

        <div class="column">
          <pre id="controller-left"><code></code></pre>
        </div>

        <div class="column">
          <pre id="controller-right"><code></code></pre>
        </div>

        <div class="column">
          <pre id="controller-left"><code></code></pre>
        </div>

      </div>

      <script src="peer.js"></script>
      <script>
        const qs = document.querySelector.bind(document)

        const id = location.search.match(/id=(.*)/)[1]
        var peer = new Peer(id, {host: location.hostname, port: location.port, path: '/peer'})

        let conn

        peer.on('open', () => log(`Signalling: Connected as "${id}"`, {color: 'green'}))
        peer.on('error', () => log('Signalling: Error'))
        peer.on('disconnected', () => log('Signalling: DISCONNECTED', {background: 'red', color: '#fff'}))

        peer.on('connection', function(_conn) {
          conn = _conn

          log(`Peer(${conn.peer}): new connection`, {color: 'green'})

          conn.on('open', () => {
            log(`Peer(${conn.peer}): connected`, {color: '#08f'})
          })

          conn.on('close', () => {
            log(`Peer(${conn.peer}): connection closed`, {color: 'red'})
          })
        })


        function log(message, style) {
          const log = qs('#log')
          while(log.childNodes.length > 100)
            log.childNodes[0].remove()

          const line = document.createElement('div')
          line.innerText = message
          Object.assign(line.style, style || {})

          log.appendChild(line)
          line.scrollIntoView()
        }

      </script>

    </div>
  </body>
</html>
