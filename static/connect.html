<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Connect</title>
    <link rel="stylesheet" href="milligram.css">
  </head>
  <body>
    <div class="container">
      <h1>Connect</h1>

      <pre><code id="log"></code></pre>

      <div class="row" id="controllers">
        <pre class="column"><code id="c1"></code></pre>
        <pre class="column"><code id="c2"></code></pre>
      </div>

      <script src="peer.js"></script>
      <script>
        let controllers = []

        const qs = document.querySelector.bind(document)
        const qsa = document.querySelectorAll.bind(document)

        const id = location.search.match(/id=(.*)/)[1]

        const peer = new Peer({host: location.hostname, port: location.port, path: '/peer'})

        const conn = peer.connect(id)

        peer.on('open', () => log(`Signalling: Connected as "${peer.id}"`, {color: 'green'}))
        peer.on('error', () => log('Signalling: Error'))
        peer.on('disconnected', () => log('Signalling: DISCONNECTED', {background: 'red', color: '#fff'}))




        function unpack(buffer, gamepadList) {

          const array = new Float32Array(buffer)
          const view = new DataView(buffer)

          const index = view.getUint8(0)
          const timestamp = view.getFloat32(1)

          if(gamepadList[index]) {
            gamepadList[index]._array.set(array)
            gamepadList[index].timestamp = timestamp
          } else {
            gamepadList[index] = {
              timestamp: timestamp,
              pose: {
                position: array.subarray(2, 5),
                orientation: array.subarray(5, 9)
              },
              _array: array
            }
          }
        }

        const remoteGamepads = []



        conn.on('open', function() {

          log(`Peer: connected to ${id}`, {color: '#08f'})

          conn.on('data', function(data){

            unpack(data, remoteGamepads)

            ;[].forEach.call(qsa('#controllers code'), (el, i) => {
              // console.log(i, controllers)
              el.innerText = JSON.stringify(remoteGamepads[i] || {}, null, 2)
            })

          })

          conn.on('close', () => {
            log('Peer: closed connection', {color: 'red', fontWeight: 800})
          })
        })




        function log(message, style) {
          const log = qs('#log')
          while(log.childNodes.length > 100)
            log.childNodes[0].remove()

          const line = document.createElement('div')
          line.innerText = message
          Object.assign(line.style, style || {})

          log.appendChild(line)
          line.scrollIntoView()
        }


      </script>

    </div>
  </body>
</html>
